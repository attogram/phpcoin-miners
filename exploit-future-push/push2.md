# `miner-push-2.php` Hashing Loop Analysis

This document provides a detailed breakdown of the `hashingLoop` function in `miner-push-2.php`. The purpose of this analysis is to identify potential areas for optimization.

## Loop Overview

The `hashingLoop` is an infinite `while(true)` loop that continuously attempts to find a valid block solution. It is the core of the miner and is responsible for the most performance-critical operations.

## Detailed Step-by-Step Breakdown

1.  **CPU Throttling:**
    *   `usleep($this->sleep_time * 1000)`
    *   The script pauses for a configurable amount of time to control CPU usage.

2.  **Time Calculation:**
    *   `$now = time()`
    *   `$elapsed = $now - $block_date`
    *   The current time is fetched, and the time elapsed since the start of the block is calculated.

3.  **Future Time Calculation (Slip Exploit):**
    *   `$solution_elapsed = $elapsed + $this->slip`
    *   `$solution_date = $block_date + $solution_elapsed`
    *   The "slip" value is added to the elapsed time to calculate a future timestamp. This is the core of the "push" mining strategy.

4.  **Argon Hash Calculation:**
    *   `$block->argon = Crypto::calculateArgonHash(...)`
    *   The Argon2i hash is calculated. This is a memory-hard function and is computationally expensive.

5.  **Nonce Calculation:**
    *   `$block->nonce = Crypto::calculateNonce(...)`
    *   The nonce is calculated based on the Argon hash and other block data. This is a fast operation (SHA-256).

6.  **Hit Calculation:**
    *   `$hit = Crypto::calculateHit($block)`
    *   The "hit" value is calculated. This involves two rounds of SHA-256 and some GMP arithmetic. It is a fast operation.

7.  **Target Calculation:**
    *   `$future_target = Crypto::calculateTarget($block->difficulty, $solution_elapsed)`
    *   The target for the future time is calculated.

8.  **Speed Measurement:**
    *   `$this->measureSpeed($hash_time_start)`
    *   The hashing speed is calculated and updated.

9.  **Statistics Reporting:**
    *   `if (time() - $last_report_time > $this->report_interval)`
    *   Periodically, the miner's status is reported to the console or a stats file.

10. **Solution Check:**
    *   `if ($hit > 0 && $future_target > 0 && $hit > $future_target)`
    *   The calculated hit is compared to the future target. If it's greater, a solution has been found.

11. **New Block Check:**
    *   `if ($this->hasNewBlock($block->prevBlockId))`
    *   Periodically (every 1 second), the miner checks if a new block has been found on the network. If so, it aborts the current work.

## Sleep and Pauses

This section details every `sleep` or `usleep` call in the entire `miner-push-2.php` script.

1.  **CPU Throttling (`usleep`):**
    *   **Location:** `hashingLoop` function.
    *   **Purpose:** To control CPU usage based on the `--cpu` configuration. The sleep time is calculated as `(100 - cpu) * 5` microseconds.
    *   **Trigger:** Called on every iteration of the mining loop.

2.  **Node Error (`sleep`):**
    *   **Location:** `start` function.
    *   **Purpose:** To prevent the miner from spamming the node with requests if the node is down or returning invalid data.
    *   **Trigger:** Called when `getMiningInfo` fails. The delay is configurable via the `--retry-delay` argument.

3.  **Post-Submission Pause (`sleep`):**
    *   **Location:** `submitBlock` function.
    *   **Purpose:** A commented-out `sleep(3)` call exists after a block is submitted. It is currently disabled.
    *   **Trigger:** None (commented out).
